name: Deploy Demo Branch to Hostinger

on:
  push:
    branches:
      - demo

jobs:
  deploy:
    name: Deploy Demo Branch
    runs-on: ubuntu-latest
    env:
      ACTIONS_RUNNER_DEBUG: true
      ACTIONS_STEP_DEBUG: true

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, ctype, json, tokenizer, curl, pdo, pdo_mysql
          coverage: none

      # Step 3: Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs

      # Step 4: Install sshpass
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass || { echo "Failed to install sshpass"; exit 1; }
          sshpass -v || { echo "sshpass not found after installation"; exit 1; }

      # Step 5: Test SSH Connection
      - name: Test SSH Connection
        run: |
          sshpass -p "${{ secrets.FTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} whoami
          sshpass -p "${{ secrets.FTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} "echo 'Test command execution' && ls -la /home/u242329769/domains/vendor.kashtre.com/public_html"

      # Step 6: Deploy to Hostinger via SSH
      - name: Deploy to Hostinger
        env:
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          # Define deployment directory
          DEPLOY_DIR="/home/u242329769/domains/vendor.kashtre.com/public_html"

          # Debug: List local files in GITHUB_WORKSPACE
          echo "Local files in GITHUB_WORKSPACE:"
          ls -la $GITHUB_WORKSPACE

          # Copy files using rsync with sshpass, excluding sensitive files
          sshpass -p "$FTP_PASSWORD" rsync -avz \
            --exclude '.env' \
            --exclude '.htaccess' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude 'vendor' \
            --exclude 'storage/logs/*' \
            --exclude 'storage/framework/cache/*' \
            --exclude 'storage/framework/sessions/*' \
            --exclude 'storage/framework/views/*' \
            -e "ssh -p 65002 -o StrictHostKeyChecking=no" \
            $GITHUB_WORKSPACE/ ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:"$DEPLOY_DIR"

          # Step 1: Set permissions and create storage link
          sshpass -p "$FTP_PASSWORD" ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} "cd $DEPLOY_DIR && \
            echo '✓ Setting permissions...' && \
            chmod -R 755 storage bootstrap/cache 2>/dev/null || echo 'Warning: Could not set permissions' && \
            echo '✓ Removing existing storage link...' && \
            rm -f public/storage 2>/dev/null || true && \
            echo '✓ Creating storage link...' && \
            /usr/bin/php artisan storage:link 2>&1 || php artisan storage:link 2>&1 || echo 'Warning: Could not create storage link'"

          # Step 2: Install dependencies on server and run migrations
          sshpass -p "$FTP_PASSWORD" ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} "cd $DEPLOY_DIR && \
            echo '✓ Finding PHP path...' && \
            PHP_PATH=\$(which php || echo 'php') && \
            echo \"Using PHP: \$PHP_PATH\" && \
            \$PHP_PATH --version && \
            echo '✓ Installing Composer dependencies...' && \
            composer install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs && \
            echo '✓ Running migrations...' && \
            \$PHP_PATH artisan migrate --force --verbose && \
            echo '✓ Checking migration status...' && \
            \$PHP_PATH artisan migrate:status && \
            echo '✓ Clearing and caching...' && \
            \$PHP_PATH artisan optimize:clear && \
            \$PHP_PATH artisan view:clear && \
            \$PHP_PATH artisan config:cache && \
            \$PHP_PATH artisan route:cache && \
            echo '✓ Deployment completed successfully!'"
